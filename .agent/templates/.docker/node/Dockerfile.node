# ==========================================
# ESTÁGIO 1: BASE E DEPENDÊNCIAS (CACHE)
# ==========================================
FROM node:20-alpine AS base

LABEL maintainer="Ambiente node"
LABEL description="Ambiente de desenvolvimento Node.js para o app Sem Susto"

WORKDIR /app

# Atualiza o npm para a versão mais recente
RUN npm install -g npm@latest --silent

# Copia os arquivos de lock e manifesto PRIMEIRO
COPY package*.json ./

# Instala as dependências aqui no build! O Docker vai fazer cache dessa camada.
# Usamos apenas o install puro; sem poluir o log.
RUN npm install --silent

# ==========================================
# ESTÁGIO 2: DESENVOLVIMENTO (Docker)
# ==========================================
FROM base AS dev

EXPOSE 5173

# Como a instalação já foi feita no Estágio 1, o container liga instantaneamente!
# O código real será injetado via Bind Mount do compose.yaml
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]

# ==========================================
# ESTÁGIO 3: PRODUÇÃO (Deploy)
# ==========================================
FROM base AS prod

# Aqui o Bind Mount não existe, então copiamos o código para dentro da imagem
COPY . .

# Faz o build de produção do Vite (gera a pasta /dist)
RUN npm run build

# Para servir um app Vite em produção, usamos um servidor estático simples
RUN npm install -g serve --silent
EXPOSE 3000
CMD ["serve", "-s", "dist", "-l", "3000"]